name: Deploy To Oracle

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: ${{ secrets.ORACLE_PORT }}
          script_stop: true
          script: |
            set -euo pipefail
            bash "apps/deploy-sdal.sh"
            EXPECTED_SHA="${{ github.sha }}"
            SHORT_SHA="${EXPECTED_SHA:0:7}"
            echo "Expected commit: ${EXPECTED_SHA}"
            ok_version=0
            ok_health=0

            for attempt in $(seq 1 24); do
              for port in 8787 3000 8080; do
                if [ "${ok_health}" -eq 0 ]; then
                  if curl -fsS --max-time 3 "http://127.0.0.1:${port}/api/health" >/dev/null; then
                    ok_health=1
                    echo "Health check passed on port ${port} (attempt ${attempt})."
                  fi
                fi

                if [ "${ok_version}" -eq 0 ]; then
                  version_json="$(curl -fsS --max-time 3 "http://127.0.0.1:${port}/api/version" || true)"
                  if [ -n "${version_json}" ]; then
                    echo "Version response (port ${port}): ${version_json}"
                    if echo "${version_json}" | grep -q "${SHORT_SHA}"; then
                      ok_version=1
                      echo "Version check passed on port ${port} (attempt ${attempt})."
                    fi
                  fi
                fi

                if [ "${ok_health}" -eq 1 ] && [ "${ok_version}" -eq 1 ]; then
                  break 2
                fi
              done
              sleep 5
            done

            if [ "${ok_health}" -ne 1 ]; then
              echo "Health check failed after deploy."
              exit 1
            fi

            if [ "${ok_version}" -ne 1 ]; then
              echo "Version check failed: deployed app is not serving expected commit ${SHORT_SHA}."
              exit 1
            fi
